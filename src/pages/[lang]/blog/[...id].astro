---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import Comments from '@/components/Comments.astro'
import Link from '@/components/Link.astro'
import PostHead from '@/components/PostHead.astro'
import PostNavigation from '@/components/PostNavigation.astro'
import SubpostsHeader from '@/components/SubpostsHeader.astro'
import SubpostsSidebar from '@/components/SubpostsSidebar.astro'
import TOCHeader from '@/components/TOCHeader.astro'
import TOCSidebar from '@/components/TOCSidebar.astro'
import { badgeVariants } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import type { ui } from '@/i18n/ui'
import { useLocalizedPath, useTranslations } from '@/i18n/utils'
import Layout from '@/layouts/Layout.astro'
import {
    getAdjacentPosts,
    getAllPostsAndSubposts,
    getCombinedReadingTime,
    getParentId,
    getParentPost,
    getPostReadingTime,
    getSubpostCount,
    getTOCSections,
    hasSubposts,
    isSubpost,
    parseAuthors,
} from '@/lib/data-utils'
import { formatDate, getTagVariant } from '@/lib/utils'
import { Icon } from 'astro-icon/components'
import { Image } from 'astro:assets'
import { render } from 'astro:content'

export async function getStaticPaths() {
    const posts = await getAllPostsAndSubposts()
    return posts.map((post) => {
        const [lang, ...idParts] = post.id.split('/')
        return {
            params: { lang, id: idParts.join('/') },
            props: post,
        }
    })
}

const post = Astro.props
const { lang, id } = Astro.params
const t = useTranslations(lang as keyof typeof ui)
const l = useLocalizedPath(lang as keyof typeof ui)

// The actual post ID in the collection includes the lang prefix
const fullPostId = post.id

// Error handling for content rendering
let Content: Awaited<ReturnType<typeof render>>['Content']
let headings: Awaited<ReturnType<typeof render>>['headings'] = []
try {
    const rendered = await render(post)
    Content = rendered.Content
    headings = rendered.headings ?? []
} catch (error) {
    console.error('Error rendering post content:', error)
    return Astro.redirect(l('/404'))
}

// Error handling for authors parsing
let authors: Awaited<ReturnType<typeof parseAuthors>> = []
try {
    authors = await parseAuthors(post.data.authors ?? [])
} catch (error) {
    console.error('Error parsing authors:', error)
}

const isCurrentSubpost = isSubpost(fullPostId)

// Error handling for navigation and metadata
let navigation: Awaited<ReturnType<typeof getAdjacentPosts>> = {
    newer: null,
    older: null,
    parent: null,
}
let parentPost: Awaited<ReturnType<typeof getParentPost>> = null
let hasChildPosts = false
let subpostCount = 0
let postReadingTime = '0 min read'
let combinedReadingTime: string | null = null
let tocSections: Awaited<ReturnType<typeof getTOCSections>> = []

try {
    navigation = await getAdjacentPosts(fullPostId)
    parentPost = isCurrentSubpost ? await getParentPost(fullPostId) : null
    hasChildPosts = await hasSubposts(fullPostId)
    subpostCount = !isCurrentSubpost ? await getSubpostCount(fullPostId) : 0
    postReadingTime = await getPostReadingTime(fullPostId)
    combinedReadingTime =
        hasChildPosts && !isCurrentSubpost
            ? await getCombinedReadingTime(fullPostId)
            : null
    tocSections = await getTOCSections(fullPostId)
} catch (error) {
    console.error('Error fetching post metadata:', error)
}
---

<Layout hideFloatingSidebar={hasChildPosts || isCurrentSubpost} lang={lang}>
    <PostHead slot="head" post={post} />
    {
        (hasChildPosts || isCurrentSubpost) && (
            <SubpostsHeader
                slot="subposts-navigation"
                parentId={
                    isCurrentSubpost ? getParentId(fullPostId) : fullPostId
                }
            />
        )
    }
    {
        headings?.length > 0 &&
            !(
                isCurrentSubpost &&
                headings.length === 1 &&
                headings[0].text === post.data.title
            ) && <TOCHeader slot="table-of-contents" headings={headings} />
    }

    <section
        class="grid grid-cols-[minmax(0px,1fr)_min(calc(var(--breakpoint-md)-2rem),100%)_minmax(0px,1fr)] gap-y-6"
    >
        <div class="col-start-2">
            <Breadcrumbs
                items={[
                    {
                        href: l('/blog'),
                        label: t('nav.blog'),
                        icon: 'lucide:library-big',
                    },
                    ...(isCurrentSubpost && parentPost
                        ? [
                              {
                                  href: l(
                                      `/blog/${parentPost.id.split('/').slice(1).join('/')}`,
                                  ),
                                  label: parentPost.data.title,
                                  icon: 'lucide:book-open',
                              },
                              {
                                  href: l(`/blog/${id}`),
                                  label: post.data.title,
                                  icon: 'lucide:file-text',
                              },
                          ]
                        : [
                              {
                                  href: l(`/blog/${id}`),
                                  label: post.data.title,
                                  icon: 'lucide:book-open-text',
                              },
                          ]),
                ]}
            />
        </div>

        {
            post.data.image && (
                <Image
                    src={post.data.image}
                    alt={post.data.title}
                    width={1200}
                    height={630}
                    class="col-span-full mx-auto w-full max-w-5xl object-cover"
                />
            )
        }

        <section class="col-start-2 flex flex-col gap-y-6 text-center">
            <div class="flex flex-col">
                <h1
                    class="mb-2 scroll-mt-31 text-3xl leading-tight font-medium sm:text-4xl"
                    id="post-title"
                >
                    {post.data.title}
                </h1>

                <div
                    class="text-muted-foreground divide-border mb-4 flex flex-col items-center justify-center divide-y text-xs sm:flex-row sm:flex-wrap sm:divide-x sm:divide-y-0 sm:text-sm"
                >
                    {
                        authors.length > 0 && (
                            <div class="flex w-full items-center justify-center gap-x-2 py-2 sm:w-fit sm:px-2 sm:py-0 first:sm:pl-0 last:sm:pr-0">
                                {authors.map((author) => (
                                    <div class="flex items-center gap-x-1.5">
                                        <Image
                                            src={author.avatar}
                                            alt={author.name}
                                            width={20}
                                            height={20}
                                            class="rounded-full"
                                        />
                                        {author.isRegistered ? (
                                            <Link
                                                href={l(
                                                    `/authors/${author.id}`,
                                                )}
                                                underline
                                                class="text-foreground"
                                            >
                                                <span>{author.name}</span>
                                            </Link>
                                        ) : (
                                            <span>{author.name}</span>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )
                    }

                    <div
                        class="flex w-full items-center justify-center gap-2 py-2 sm:w-fit sm:px-2 sm:py-0 first:sm:pl-0 last:sm:pr-0"
                    >
                        <span>{formatDate(post.data.date)}</span>
                    </div>

                    <div
                        class="flex w-full items-center justify-center gap-2 py-2 sm:w-fit sm:px-2 sm:py-0 first:sm:pl-0 last:sm:pr-0"
                    >
                        <span>
                            {postReadingTime}
                            {
                                combinedReadingTime &&
                                    combinedReadingTime !== postReadingTime && (
                                        <span class="text-muted-foreground">
                                            {' '}
                                            ({combinedReadingTime} total)
                                        </span>
                                    )
                            }
                        </span>
                    </div>

                    {
                        subpostCount > 0 && (
                            <div class="flex w-full items-center justify-center gap-1 py-2 sm:w-fit sm:px-2 sm:py-0 first:sm:pl-0 last:sm:pr-0">
                                <Icon name="lucide:file-text" class="size-3" />
                                {subpostCount}{' '}
                                {lang === 'en'
                                    ? `subpost${subpostCount === 1 ? '' : 's'}`
                                    : 'ç« '}
                            </div>
                        )
                    }
                </div>
                <div class="flex flex-wrap justify-center gap-2">
                    {
                        post.data.tags &&
                            post.data.tags.length > 0 &&
                            post.data.tags.map((tag) => {
                                const { variant, className } =
                                    getTagVariant(tag)
                                return (
                                    <div class="group relative">
                                        <a
                                            href={l(`/tags/${tag}`)}
                                            class={`${badgeVariants({ variant })} ${className || ''}`}
                                        >
                                            <Icon
                                                name="lucide:hash"
                                                class="size-3"
                                            />
                                            {tag}
                                        </a>
                                    </div>
                                )
                            })
                    }
                </div>
            </div>

            <PostNavigation
                newerPost={navigation.newer}
                olderPost={navigation.older}
                parentPost={isCurrentSubpost ? navigation.parent : undefined}
            />
        </section>

        {
            tocSections.length > 0 && (
                <TOCSidebar sections={tocSections} currentPostId={fullPostId} />
            )
        }

        <article class="prose col-start-2 max-w-none">
            <Content />
        </article>

        {
            (hasChildPosts || isCurrentSubpost) && (
                <SubpostsSidebar
                    parentId={
                        isCurrentSubpost ? getParentId(fullPostId) : fullPostId
                    }
                    className="w-64"
                />
            )
        }

        <PostNavigation
            newerPost={navigation.newer}
            olderPost={navigation.older}
            parentPost={isCurrentSubpost ? navigation.parent : undefined}
        />

        {
            !isCurrentSubpost && (
                <div class="col-start-2 mt-12">
                    <Comments
                        postId={`blog-${fullPostId}`}
                        title={post.data.title}
                    />
                </div>
            )
        }
    </section>

    <Button
        variant="outline"
        size="icon"
        className="group fixed right-8 bottom-8 z-50 hidden"
        id="scroll-to-top"
        title="Scroll to top"
        aria-label="Scroll to top"
    >
        <Icon
            name="lucide:arrow-up"
            class="mx-auto size-4 transition-all group-hover:-translate-y-0.5"
        />
    </Button>

    <script>
        document.addEventListener('astro:page-load', () => {
            const scrollToTopButton = document.getElementById('scroll-to-top')
            const footer = document.querySelector('footer')

            if (scrollToTopButton && footer) {
                scrollToTopButton.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' })
                })

                window.addEventListener('scroll', () => {
                    const footerRect = footer.getBoundingClientRect()
                    const isFooterVisible = footerRect.top <= window.innerHeight

                    scrollToTopButton.classList.toggle(
                        'hidden',
                        window.scrollY <= 300 || isFooterVisible,
                    )
                })
            }
        })
    </script>
</Layout>
