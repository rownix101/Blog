---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import { SOCIAL_LINKS } from '@/consts'
import { languages, ui } from '@/i18n/ui'
import { useTranslations } from '@/i18n/utils'
import Layout from '@/layouts/Layout.astro'
import { Icon } from 'astro-icon/components'
import { getCollection, render } from 'astro:content'

export async function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({ params: { lang } }))
}

const { lang } = Astro.params
const locale = (lang || 'zh-cn').toLowerCase()
const t = useTranslations(locale as keyof typeof ui)

// Get contact email from social links or use placeholder
const contactEmail =
  SOCIAL_LINKS.find((link) => link.label === 'Email')?.href.replace(
    'mailto:',
    '',
  ) || 'your@email.com'

// Get privacy policy content
const legalDocs = await getCollection('legal')
const preferredLangs = [locale, 'en', 'zh-cn']
const privacyDoc = preferredLangs
  .map((preferredLang) =>
    legalDocs.find((doc) => doc.id === `privacy.${preferredLang}`),
  )
  .find(Boolean)

if (!privacyDoc) {
  throw new Error(`Privacy policy not found for language: ${lang}`)
}

const { Content } = await render(privacyDoc)
---

<Layout class="max-w-3xl" lang={locale}>
  <PageHead slot="head" title={privacyDoc.data.title} />
  <Breadcrumbs
    items={[{ label: privacyDoc.data.title, icon: 'lucide:shield-check' }]}
  />

  <article class="prose prose-neutral dark:prose-invert max-w-none">
    <div class="bg-card/50 mb-6 rounded-lg border p-6">
      <div class="mb-2 flex items-center gap-3">
        <Icon name="lucide:shield-check" class="text-primary size-6" />
        <h1 class="m-0 text-3xl font-bold">{privacyDoc.data.title}</h1>
      </div>
      {
        privacyDoc.data.date && (
          <p class="text-muted-foreground m-0 text-sm">
            {t('legal.last_updated')}:{' '}
            {privacyDoc.data.date.toISOString().split('T')[0]}
          </p>
        )
      }
    </div>

    <section class="mb-8 space-y-6">
      <Content />
    </section>

    <section class="mb-8 space-y-4">
      <h2 class="text-2xl font-semibold">{t('legal.contact_us')}</h2>
      <div class="bg-muted/30 rounded-lg border p-4">
        <p class="m-0">{t('legal.privacy_contact_desc')}</p>
        <p class="mt-2">
          <strong>Email:</strong>
          <a
            href={`mailto:${contactEmail}`}
            class="hover:text-primary underline transition-colors"
            >{contactEmail}</a
          >
        </p>
      </div>
    </section>
  </article>
</Layout>
