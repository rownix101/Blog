---
// 点赞按钮组件
interface Props {
  commentId: number
  initialLikes?: number
  initialLiked?: boolean
}

const { commentId, initialLikes = 0, initialLiked = false } = Astro.props
---

<div class="like-button-container" data-comment-id="{commentId}">
  <button
    class="like-button group inline-flex items-center gap-2 px-3 py-1.5 text-sm rounded-full transition-all duration-200 hover:bg-muted/50"
    type="button"
    aria-label="Like comment"
  >
    <svg
      class="like-icon w-4 h-4 transition-all duration-200 {initialLiked ? 'text-red-500 fill-current' : 'text-muted-foreground'}"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
      />
    </svg>
    <span class="like-count font-medium text-muted-foreground">{initialLikes}</span>
    <span class="like-text text-xs text-muted-foreground group-hover:text-foreground">
      {initialLiked ? 'Liked' : 'Like'}
    </span>
  </button>

  <!-- 加载状态 -->
  <div class="like-loading hidden">
    <div class="inline-flex items-center gap-2 px-3 py-1.5 text-sm">
      <div class="w-4 h-4 animate-spin rounded-full border-2 border-muted border-t-foreground"></div>
      <span class="text-muted-foreground">Loading...</span>
    </div>
  </div>

  <!-- 错误提示 -->
  <div class="like-error hidden">
    <span class="text-xs text-red-500">Failed to like</span>
  </div>
</div>

<script define:vars={{ commentId }}>
  class LikeButton {
    constructor(commentId) {
      this.commentId = commentId
      this.container = document.querySelector(`[data-comment-id="${commentId}"]`)
      this.button = this.container?.querySelector('.like-button')
      this.icon = this.container?.querySelector('.like-icon')
      this.count = this.container?.querySelector('.like-count')
      this.text = this.container?.querySelector('.like-text')
      this.loading = this.container?.querySelector('.like-loading')
      this.error = this.container?.querySelector('.like-error')

      this.isLiked = false
      this.totalLikes = 0
      this.isLoading = false

      this.init()
    }

    init() {
      if (!this.button) return

      this.button.addEventListener('click', () => this.handleLike())
      this.loadLikeStatus()
    }

    async loadLikeStatus() {
      try {
        const response = await fetch(`/api/likes/${this.commentId}`)
        if (response.ok) {
          const data = await response.json()
          this.updateUI(data.totalLikes, data.userLiked)
        }
      } catch (error) {
        console.error('Load like status error:', error)
      }
    }

    async handleLike() {
      if (this.isLoading) return

      this.setLoading(true)
      this.hideError()

      try {
        const response = await fetch(`/api/likes/${this.commentId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })

        if (response.ok) {
          const data = await response.json()
          this.updateUI(data.totalLikes, data.liked)

          // 添加动画效果
          this.animateLike(data.liked)

          // 显示提示
          this.showToast(data.message, data.liked ? 'success' : 'info')
        } else {
          const errorData = await response.json()
          this.showError()
          this.showToast(errorData.error || 'Failed to like comment', 'error')
        }
      } catch (error) {
        console.error('Like error:', error)
        this.showError()
        this.showToast('Network error', 'error')
      } finally {
        this.setLoading(false)
      }
    }

    updateUI(totalLikes, isLiked) {
      this.totalLikes = totalLikes
      this.isLiked = isLiked

      if (this.count) {
        this.count.textContent = totalLikes
      }

      if (this.icon) {
        if (isLiked) {
          this.icon.classList.add('text-red-500', 'fill-current')
          this.icon.classList.remove('text-muted-foreground')
        } else {
          this.icon.classList.remove('text-red-500', 'fill-current')
          this.icon.classList.add('text-muted-foreground')
        }
      }

      if (this.text) {
        this.text.textContent = isLiked ? 'Liked' : 'Like'
      }
    }

    animateLike(liked) {
      if (!this.icon) return

      if (liked) {
        // 点赞动画
        this.icon.style.transform = 'scale(1.3)'
        setTimeout(() => {
          this.icon.style.transform = 'scale(1)'
        }, 150)

        // 创建爱心飘散效果
        this.createHeartParticles()
      } else {
        // 取消点赞动画
        this.icon.style.transform = 'scale(0.8)'
        setTimeout(() => {
          this.icon.style.transform = 'scale(1)'
        }, 150)
      }
    }

    createHeartParticles() {
      if (!this.button) return

      const colors = ['#ef4444', '#f87171', '#fca5a5']

      for (let i = 0; i < 3; i++) {
        const particle = document.createElement('div')
        particle.textContent = '❤️'
        particle.style.cssText = `
          position: absolute;
          pointer-events: none;
          font-size: ${12 + Math.random() * 8}px;
          color: ${colors[Math.floor(Math.random() * colors.length)]};
          z-index: 1000;
          animation: float-up ${1 + Math.random()}s ease-out forwards;
        `

        const rect = this.button.getBoundingClientRect()
        particle.style.left = `${rect.left + rect.width / 2 + (Math.random() - 0.5) * 20}px`
        particle.style.top = `${rect.top + rect.height / 2}px`

        document.body.appendChild(particle)

        setTimeout(() => particle.remove(), 2000)
      }
    }

    setLoading(isLoading) {
      this.isLoading = isLoading

      if (this.button) {
        this.button.classList.toggle('hidden', isLoading)
      }

      if (this.loading) {
        this.loading.classList.toggle('hidden', !isLoading)
      }
    }

    showError() {
      if (this.error) {
        this.error.classList.remove('hidden')
        setTimeout(() => {
          this.error.classList.add('hidden')
        }, 3000)
      }
    }

    hideError() {
      if (this.error) {
        this.error.classList.add('hidden')
      }
    }

    showToast(message, type = 'info') {
      const toast = document.createElement('div')
      toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md text-white z-50 text-sm ${
        type === 'success' ? 'bg-green-600' :
        type === 'error' ? 'bg-red-600' : 'bg-blue-600'
      }`
      toast.textContent = message
      document.body.appendChild(toast)

      setTimeout(() => {
        toast.style.opacity = '0'
        toast.style.transform = 'translateY(10px)'
        setTimeout(() => toast.remove(), 300)
      }, 2000)
    }
  }

  // 添加 CSS 动画
  const style = document.createElement('style')
  style.textContent = `
    @keyframes float-up {
      0% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateY(-50px) scale(0.5);
      }
    }

    .like-button:hover .like-icon {
      transform: scale(1.1);
    }

    .like-button:active .like-icon {
      transform: scale(0.95);
    }
  `
  document.head.appendChild(style)

  // 初始化点赞按钮
  document.addEventListener('DOMContentLoaded', () => {
    new LikeButton(commentId)
  })
</script>