---
import MobileMenuSheet from '@/components/react/MobileMenuSheet'
import { NAV_LINKS } from '@/consts'
import { languages, ui } from '@/i18n/ui'
import { useLocalizedPath, useTranslations } from '@/i18n/utils'

interface Props {
  lang?: string
}

const { lang = 'zh-cn' } = Astro.props as Props
const t = useTranslations(lang as keyof typeof ui)
const l = useLocalizedPath(lang as keyof typeof ui)
const currentPath = Astro.url.pathname

const isExternalLink = (href: string) => {
  return href.startsWith('http')
}

const getPathWithoutLang = (pathname: string): string => {
  const segments = pathname.split('/').filter(Boolean)
  if (segments.length > 0 && segments[0] in languages) {
    return '/' + segments.slice(1).join('/')
  }
  return pathname
}

const basePath = getPathWithoutLang(currentPath)

const menuItems = NAV_LINKS.map((item) => {
  const isExternal = isExternalLink(item.href)
  const isInsideLink = item.label.toLowerCase() === 'inside'
  const translatedLabel =
    t(`nav.${item.label.toLowerCase()}` as any) || item.label
  return {
    href: isExternal ? item.href : l(item.href),
    label: translatedLabel,
    isExternal,
    isInside: isInsideLink,
  }
})

const languageItems = Object.entries(languages).map(([code, label]) => {
  return {
    code,
    label,
    href: `/${code}${basePath}`,
    isActive: code === lang,
  }
})
---

<MobileMenuSheet
  items={menuItems}
  languages={languageItems}
  searchLabel={t('menu.search')}
  languageLabel={t('menu.language')}
  client:load
/>
