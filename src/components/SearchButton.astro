---
import { buttonVariants } from '@/components/ui/button'
import { Icon } from 'astro-icon/components'

interface Props {
  lang?: string
}

const { lang = 'zh-cn' } = Astro.props
const buttonClass =
  buttonVariants({ variant: 'outline', size: 'icon' }) +
  ' size-11 border md:border-0 md:bg-transparent md:hover:bg-muted md:-my-2 md:-me-2 md:size-9'
---

<button
  type="button"
  class={buttonClass}
  data-search-button
  data-search-lang={lang}
  title="Search (âŒ˜K)"
  aria-label="Search blog posts"
  aria-haspopup="dialog"
>
  <Icon name="lucide:search" class="h-5 w-5 md:h-4 md:w-4" />
  <span class="sr-only">Search</span>
</button>

<script>
  ;(function () {
    /** @typedef {{ open: () => void }} SearchApi */
    /** @type {Promise<SearchApi> | null} */
    let searchApiPromise = null
    /** @type {string | null} */
    let lastLang = null

    /** @type {Window & { __searchDialogInit?: boolean }} */
    const win = window

    const getLang = () => {
      const el = document.querySelector('[data-search-button]')
      if (!el || !(el instanceof HTMLElement)) return 'zh-cn'
      return el.dataset.searchLang || 'zh-cn'
    }

    const isTypingTarget = (target) => {
      const el = target instanceof HTMLElement ? target : null
      return (
        !!el &&
        (el.tagName === 'INPUT' ||
          el.tagName === 'TEXTAREA' ||
          el.isContentEditable)
      )
    }

    const openSearch = async () => {
      const lang = getLang()
      if (!searchApiPromise || lastLang !== lang) {
        lastLang = lang
        searchApiPromise = import('@/components/react/search-client').then(
          (mod) => mod.initSearchDialog({ lang }),
        )
      }
      const api = await searchApiPromise
      api.open()
    }

    const bindButton = () => {
      const button = document.querySelector('[data-search-button]')
      if (!button || !(button instanceof HTMLElement)) return
      if (button.dataset.searchBound) return
      button.dataset.searchBound = 'true'
      button.addEventListener('click', () => {
        void openSearch()
      })
    }

    bindButton()
    document.addEventListener('astro:after-swap', bindButton)

    if (!win.__searchDialogInit) {
      win.__searchDialogInit = true
      win.addEventListener('keydown', (e) => {
        if (
          (e.metaKey || e.ctrlKey) &&
          e.key === 'k' &&
          !isTypingTarget(e.target)
        ) {
          e.preventDefault()
          void openSearch()
        }
      })
    }
  })()
</script>
