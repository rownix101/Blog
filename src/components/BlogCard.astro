---
import {
  getCombinedReadingTime,
  getSubpostCount,
  isSubpost,
  parseAuthors,
} from '@/lib/data-utils'
import { formatDate, getTagVariant } from '@/lib/utils'
import { Icon } from 'astro-icon/components'
import type { CollectionEntry } from 'astro:content'
import Link from './Link.astro'

interface Props {
  entry: CollectionEntry<'blog'>
}

const { entry } = Astro.props
const formattedDate = formatDate(entry.data.date)
const readTime = await getCombinedReadingTime(entry.id)
const authors = await parseAuthors(entry.data.authors ?? [])
const subpostCount = !isSubpost(entry.id) ? await getSubpostCount(entry.id) : 0
const [lang, ...idParts] = entry.id.split('/')
const id = idParts.join('/')
---

<Link
  href={`/${lang}/blog/${id}`}
  class="group hover:bg-muted/30 -mx-2 block rounded-md px-2 py-4 transition-all duration-200"
>
  <div class="flex items-start justify-between gap-4">
    <div class="min-w-0 flex-1 space-y-1">
      <div class="flex items-baseline gap-2.5">
        <h3
          class="group-hover:text-foreground text-base leading-snug font-semibold transition-colors"
        >
          {entry.data.title}
        </h3>
        <span
          class="text-muted-foreground/60 shrink-0 text-xs font-normal whitespace-nowrap"
        >
          {formattedDate}
        </span>
      </div>
      <p class="text-muted-foreground line-clamp-1 text-sm leading-snug">
        {entry.data.description}
      </p>
      <div
        class="text-muted-foreground/80 flex flex-wrap items-center gap-x-2.5 gap-y-1 text-xs"
      >
        {
          authors.length > 0 && (
            <span class="font-medium">
              {authors.map((a) => a.name).join(', ')}
            </span>
          )
        }
        {authors.length > 0 && <span class="text-muted-foreground/40">·</span>}
        <span class="flex items-center gap-1">
          <Icon name="lucide:clock" class="text-primary/70 size-3" />
          {readTime}
        </span>
        {
          subpostCount > 0 && (
            <>
              <span class="text-muted-foreground/40">·</span>
              <span class="flex items-center gap-1">
                <Icon name="lucide:file-text" class="size-3" />
                {subpostCount}
              </span>
            </>
          )
        }
        {
          entry.data.tags && entry.data.tags.length > 0 && (
            <>
              <span class="text-muted-foreground/40">·</span>
              <div class="flex flex-wrap items-center gap-1">
                {entry.data.tags.slice(0, 2).map((tag) => {
                  const { className, tooltip } = getTagVariant(tag)
                  return (
                    <div class="group/tag relative">
                      <span
                        class={`text-muted-foreground/70 hover:text-foreground rounded px-1.5 py-0.5 text-[10px] font-medium transition-colors ${className || ''}`}
                      >
                        {tag}
                      </span>
                      {tooltip && (
                        <span class="pointer-events-none invisible absolute bottom-full left-1/2 z-[100] mb-2 w-max max-w-xs -translate-x-1/2 rounded-md border border-gray-700 bg-gray-900 px-2 py-1 text-[10px] text-white opacity-0 shadow-xl transition-all duration-200 group-hover/tag:visible group-hover/tag:opacity-100 dark:border-gray-200 dark:bg-gray-50 dark:text-gray-900">
                          {tooltip}
                          <span class="absolute top-full left-1/2 h-0 w-0 -translate-x-1/2 border-t-[4px] border-r-[4px] border-l-[4px] border-t-gray-900 border-r-transparent border-l-transparent dark:border-t-gray-50" />
                        </span>
                      )}
                    </div>
                  )
                })}
                {entry.data.tags.length > 2 && (
                  <span class="text-muted-foreground/50 text-[10px]">
                    +{entry.data.tags.length - 2}
                  </span>
                )}
              </div>
            </>
          )
        }
      </div>
    </div>
  </div>
</Link>
