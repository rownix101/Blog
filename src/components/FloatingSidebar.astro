---
import Link from '@/components/Link.astro'
import { getSortedTags } from '@/lib/data-utils'
import { Icon } from 'astro-icon/components'

interface Props {
  lang?: string
}

const { lang = 'zh-cn' } = Astro.props

const sortedTags = await getSortedTags()
const popularTags = sortedTags.slice(0, 6) // Top 6 tags

// Positioning options:
// 'right-fixed' - Current: Fixed right side (good visibility, always accessible)
// 'bottom-bar' - Horizontal bar at bottom (modern, less intrusive)
// 'bottom-right-corner' - Compact corner widget (minimal, modern)
// 'left-fixed' - Fixed left side (natural reading flow, but may conflict)
type Position =
  | 'right-fixed'
  | 'bottom-bar'
  | 'bottom-right-corner'
  | 'left-fixed'
const position: Position = 'right-fixed' as Position // Change this to test different positions
---

{
  position === 'right-fixed' && (
    <div
      id="floating-sidebar"
      class="animate-fade-in fixed top-32 right-6 z-40 hidden opacity-0 xl:block"
      aria-label="Support and advertising"
      data-floating-sidebar
    >
      <div class="border-border/40 bg-background/80 w-56 rounded-lg border shadow-sm backdrop-blur-md transition-all duration-300 hover:shadow-md">
        <div class="flex flex-col gap-4 p-4">
          {/** Support Section */}
          <div>
            <h3 class="text-foreground mb-1.5 text-sm font-medium">
              Support My Work
            </h3>
            <p class="text-muted-foreground mb-3 text-xs leading-snug">
              Help fuel the server and keep the content coming
            </p>
            <a
              href="https://buymeacoffee.com/rownix101"
              target="_blank"
              rel="noopener noreferrer"
              class="bg-primary text-primary-foreground hover:bg-primary/90 inline-flex w-full items-center justify-center gap-1.5 rounded-md px-3 py-2 text-xs font-medium transition-all duration-200 active:scale-[0.98]"
            >
              <Icon name="lucide:coffee" class="h-3.5 w-3.5" />
              <span>Buy Me a Coffee</span>
            </a>
          </div>

          {/** Quick Links */}
          <div class="border-border/40 border-t pt-3">
            <div class="flex gap-2">
              <Link
                href={`/${lang}/rss.xml`}
                class="border-border/60 bg-background text-foreground hover:bg-muted/50 hover:border-border inline-flex flex-1 items-center justify-center gap-1.5 rounded-md border px-3 py-2 text-xs font-medium transition-all duration-200 active:scale-[0.98]"
                title="RSS Feed"
              >
                <Icon name="lucide:rss" class="h-3.5 w-3.5" />
                <span>RSS</span>
              </Link>
            </div>
          </div>

          {/** Popular Tags */}
          {popularTags.length > 0 && (
            <div class="border-border/40 border-t pt-3">
              <h3 class="text-foreground mb-2 text-xs font-medium">
                Popular Tags
              </h3>
              <div class="flex flex-wrap gap-1.5">
                {popularTags.map(({ tag }) => (
                  <Link
                    href={`/tags/${tag}`}
                    class="bg-muted/50 text-muted-foreground hover:bg-muted hover:text-foreground inline-flex items-center gap-1 rounded-md px-2 py-1 text-[10px] font-medium transition-colors"
                  >
                    <Icon name="lucide:hash" class="h-3 w-3" />
                    {tag}
                  </Link>
                ))}
              </div>
            </div>
          )}

          {/** Advertising Section */}
          <div class="border-border/40 border-t pt-3">
            <h3 class="text-foreground mb-1.5 text-xs font-medium">
              Advertise Here
            </h3>
            <p class="text-muted-foreground mb-2.5 text-[10px] leading-snug">
              Reach a tech-savvy audience interested in infrastructure, DevOps,
              and homelab content
            </p>
            <a
              href="mailto:rownix101@gmail.com?subject=Advertising Inquiry"
              class="border-border/60 bg-background text-foreground hover:bg-muted/50 hover:border-border mb-2 inline-flex w-full items-center justify-center gap-1.5 rounded-md border px-3 py-2 text-xs font-medium transition-all duration-200 active:scale-[0.98]"
            >
              <Icon name="lucide:mail" class="h-3.5 w-3.5" />
              <span>Contact for Ads</span>
            </a>
            <p class="text-muted-foreground/70 text-center text-[10px]">
              Ad space available â€¢ Desktop only
            </p>
          </div>
        </div>
      </div>
    </div>
  )
}

{
  position === 'bottom-bar' && (
    <div
      id="floating-sidebar"
      class="animate-fade-in border-border/40 bg-background/95 fixed right-0 bottom-0 left-0 z-40 hidden border-t opacity-0 shadow-lg backdrop-blur-md xl:block"
      aria-label="Support and advertising"
    >
      <div class="mx-auto max-w-7xl px-6 py-3">
        <div class="flex items-center justify-between gap-6">
          {/** Support */}
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
              <div>
                <h3 class="text-foreground text-xs font-medium">
                  Support My Work
                </h3>
                <p class="text-muted-foreground text-[10px]">
                  Help fuel the server
                </p>
              </div>
              <a
                href="https://buymeacoffee.com/rownix101"
                target="_blank"
                rel="noopener noreferrer"
                class="bg-primary text-primary-foreground hover:bg-primary/90 inline-flex items-center gap-1.5 rounded-md px-3 py-1.5 text-xs font-medium transition-all duration-200"
              >
                <Icon name="lucide:coffee" class="h-3.5 w-3.5" />
                <span>Buy Me a Coffee</span>
              </a>
            </div>
          </div>

          {/** Quick Links & Tags */}
          <div class="flex items-center gap-4">
            <Link
              href={`/${lang}/rss.xml`}
              class="border-border/60 bg-background text-foreground hover:bg-muted/50 inline-flex items-center gap-1.5 rounded-md border px-3 py-1.5 text-xs font-medium transition-all duration-200"
            >
              <Icon name="lucide:rss" class="h-3.5 w-3.5" />
              <span>RSS</span>
            </Link>

            {popularTags.length > 0 && (
              <div class="flex items-center gap-2">
                <span class="text-muted-foreground text-[10px]">Tags:</span>
                <div class="flex flex-wrap gap-1">
                  {popularTags.slice(0, 4).map(({ tag }) => (
                    <Link
                      href={`/tags/${tag}`}
                      class="bg-muted/50 text-muted-foreground hover:bg-muted hover:text-foreground inline-flex items-center gap-0.5 rounded px-1.5 py-0.5 text-[10px] font-medium transition-colors"
                    >
                      <Icon name="lucide:hash" class="h-2.5 w-2.5" />
                      {tag}
                    </Link>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/** Advertising */}
          <div class="flex items-center gap-3">
            <a
              href="mailto:rownix101@gmail.com?subject=Advertising Inquiry"
              class="border-border/60 bg-background text-foreground hover:bg-muted/50 inline-flex items-center gap-1.5 rounded-md border px-3 py-1.5 text-xs font-medium transition-all duration-200"
            >
              <Icon name="lucide:mail" class="h-3.5 w-3.5" />
              <span>Advertise</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  )
}

{
  position === 'bottom-right-corner' && (
    <div
      id="floating-sidebar"
      class="animate-fade-in fixed right-6 bottom-6 z-40 hidden opacity-0 xl:block"
      aria-label="Support and advertising"
    >
      <div class="border-border/40 bg-background/95 w-64 rounded-lg border shadow-lg backdrop-blur-md">
        <div class="flex flex-col gap-3 p-4">
          {/** Support */}
          <a
            href="https://buymeacoffee.com/rownix101"
            target="_blank"
            rel="noopener noreferrer"
            class="bg-primary/10 hover:bg-primary/20 group inline-flex items-center justify-between gap-2 rounded-md p-3 transition-colors"
          >
            <div class="flex items-center gap-2">
              <Icon name="lucide:coffee" class="text-primary h-4 w-4" />
              <div>
                <div class="text-foreground text-xs font-medium">
                  Support My Work
                </div>
                <div class="text-muted-foreground text-[10px]">
                  Buy Me a Coffee
                </div>
              </div>
            </div>
            <Icon
              name="lucide:external-link"
              class="text-muted-foreground group-hover:text-foreground h-3.5 w-3.5"
            />
          </a>

          {/** Quick Actions */}
          <div class="flex gap-2">
            <Link
              href={`/${lang}/rss.xml`}
              class="border-border/60 bg-background text-foreground hover:bg-muted/50 inline-flex flex-1 items-center justify-center gap-1.5 rounded-md border px-3 py-2 text-xs font-medium transition-all duration-200"
            >
              <Icon name="lucide:rss" class="h-3.5 w-3.5" />
              <span>RSS</span>
            </Link>
            <a
              href="mailto:rownix101@gmail.com?subject=Advertising Inquiry"
              class="border-border/60 bg-background text-foreground hover:bg-muted/50 inline-flex flex-1 items-center justify-center gap-1.5 rounded-md border px-3 py-2 text-xs font-medium transition-all duration-200"
            >
              <Icon name="lucide:mail" class="h-3.5 w-3.5" />
              <span>Ads</span>
            </a>
          </div>

          {/** Tags */}
          {popularTags.length > 0 && (
            <div>
              <div class="text-muted-foreground mb-1.5 text-[10px] font-medium">
                Popular Tags
              </div>
              <div class="flex flex-wrap gap-1">
                {popularTags.map(({ tag }) => (
                  <Link
                    href={`/tags/${tag}`}
                    class="bg-muted/50 text-muted-foreground hover:bg-muted hover:text-foreground inline-flex items-center gap-0.5 rounded px-1.5 py-0.5 text-[10px] font-medium transition-colors"
                  >
                    <Icon name="lucide:hash" class="h-2.5 w-2.5" />
                    {tag}
                  </Link>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

<style>
  /* Fade-in animation on page load */
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateX(10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #floating-sidebar.animate-fade-in {
    animation: fade-in 0.4s ease-out 0.2s forwards;
  }

  #floating-sidebar[class*='bottom-bar'] {
    animation: fade-in-up 0.4s ease-out 0.2s forwards;
  }

  /* Respect user motion preferences */
  @media (prefers-reduced-motion: reduce) {
    #floating-sidebar *,
    #floating-sidebar {
      transition: none !important;
      animation: none !important;
      opacity: 1 !important;
      transform: none !important;
    }
  }

  /* Responsive positioning for right-fixed */
  @media (min-width: 1280px) {
    #floating-sidebar[class*='right'] {
      right: 1.5rem;
    }
  }

  @media (min-width: 1280px) and (max-width: 1400px) {
    #floating-sidebar[class*='right'] {
      right: 1rem;
    }
  }

  @media (min-width: 1920px) {
    #floating-sidebar[class*='right'] {
      right: 2rem;
    }
  }

  /* Hide on mobile and tablet */
  @media (max-width: 1279px) {
    #floating-sidebar {
      display: none !important;
    }
  }
</style>

<script>
  // Prevent floating sidebar from overlapping footer
  function updateSidebarPosition() {
    const sidebar = document.querySelector(
      '[data-floating-sidebar]',
    ) as HTMLElement | null
    if (!sidebar) return

    const footer = document.querySelector('footer') as HTMLElement | null
    if (!footer) return

    const sidebarRect = sidebar.getBoundingClientRect()
    const footerRect = footer.getBoundingClientRect()
    const sidebarHeight = sidebarRect.height
    const topOffset = 128 // top-32 = 8rem = 128px

    // Calculate if sidebar would overlap footer
    const sidebarBottom = window.scrollY + sidebarRect.top + sidebarHeight
    const footerTop = window.scrollY + footerRect.top

    // If sidebar would overlap footer, adjust its position
    if (sidebarBottom > footerTop - 24) {
      const maxBottom = footerTop - window.scrollY - 24 // 24px gap above footer
      const maxTop = maxBottom - sidebarHeight
      sidebar.style.top = `${Math.max(topOffset, maxTop)}px`
      sidebar.style.bottom = 'auto'
    } else {
      // Reset to original position
      sidebar.style.top = '8rem' // top-32
      sidebar.style.bottom = 'auto'
    }
  }

  // Update on scroll and resize
  let ticking = false
  function handleUpdate() {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateSidebarPosition()
        ticking = false
      })
      ticking = true
    }
  }

  // Initialize on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      updateSidebarPosition()
      window.addEventListener('scroll', handleUpdate, { passive: true })
      window.addEventListener('resize', handleUpdate, { passive: true })
    })
  } else {
    updateSidebarPosition()
    window.addEventListener('scroll', handleUpdate, { passive: true })
    window.addEventListener('resize', handleUpdate, { passive: true })
  }

  // Update on Astro navigation
  document.addEventListener('astro:page-load', () => {
    setTimeout(updateSidebarPosition, 100)
  })
</script>
