---
import { buttonVariants } from '@/components/ui/button'
import { languages } from '@/i18n/ui'
import { getLangFromUrl } from '@/i18n/utils'
import { cn } from '@/lib/utils'
import { Icon } from 'astro-icon/components'

const lang = getLangFromUrl(Astro.url)
---

<div class="flex items-center gap-1">
  <div class="group relative">
    <button
      class={buttonVariants({ variant: 'ghost', size: 'sm' }) +
        ' flex items-center gap-1.5 px-2'}
      aria-label="Select Language"
    >
      <Icon name="lucide:globe" class="size-4" />
      <span class="text-xs font-medium uppercase">{lang}</span>
      <Icon
        name="lucide:chevron-down"
        class="size-3 opacity-50 transition-transform group-hover:rotate-180"
      />
    </button>

    <div
      class="bg-popover invisible absolute top-full right-0 z-50 mt-1 w-32 rounded-md border p-1 opacity-0 shadow-md transition-all duration-200 group-focus-within:visible group-focus-within:opacity-100 group-hover:visible group-hover:opacity-100"
    >
      {
        Object.entries(languages).map(([code, label]) => (
          <a
            href={`/${code}/${Astro.url.pathname.split('/').slice(2).join('/')}`}
            onclick={`document.cookie = 'language=${code}; path=/; max-age=31536000; sameSite=Lax';`}
            class={cn(
              'hover:bg-accent hover:text-accent-foreground flex items-center justify-between rounded-sm px-2 py-1.5 text-xs transition-colors',
              lang === code ? 'bg-accent/50 font-medium' : '',
            )}
          >
            {label}
            {lang === code && (
              <Icon name="lucide:check" class="text-primary size-3" />
            )}
          </a>
        ))
      }
    </div>
  </div>
</div>

<script>
  // 语言检测和重定向由服务器端的 index.astro 处理
  // 此组件仅用于语言切换 UI
</script>
